<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stampify - Application de filigrane PDF 100% locale">
    <meta name="author" content="YannMSFT">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <title>Stampify - Filigrane PDF</title>
    
    <!-- T003: CSS Variables and Base Styles -->
    <style>
        /* ========== CSS Variables ========== */
        :root {
            /* Colors */
            --color-primary: #2563eb;
            --color-primary-hover: #1d4ed8;
            --color-primary-light: #dbeafe;
            --color-success: #22c55e;
            --color-error: #ef4444;
            --color-error-light: #fef2f2;
            --color-warning: #f59e0b;
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-400: #9ca3af;
            --color-gray-500: #6b7280;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-800: #1f2937;
            --color-gray-900: #111827;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 2rem;
            
            /* Border Radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }
        
        /* ========== Reset & Base ========== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
        }
        
        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--color-gray-800);
            background: var(--color-gray-50);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* ========== Layout ========== */
        header {
            background: white;
            border-bottom: 1px solid var(--color-gray-200);
            padding: var(--spacing-md) var(--spacing-xl);
            box-shadow: var(--shadow-sm);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .logo {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }
        
        .tagline {
            color: var(--color-gray-500);
            font-size: var(--font-size-sm);
        }
        
        main {
            flex: 1;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: var(--spacing-xl);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xl);
        }
        
        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        footer {
            background: white;
            border-top: 1px solid var(--color-gray-200);
            padding: var(--spacing-md) var(--spacing-xl);
            text-align: center;
            color: var(--color-gray-500);
            font-size: var(--font-size-sm);
        }
        
        footer a {
            color: var(--color-primary);
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        /* ========== Cards ========== */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-lg);
        }
        
        .card-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-gray-800);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        /* ========== Upload Zone ========== */
        .upload-zone {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            background: var(--color-gray-50);
        }
        
        .upload-zone:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }
        
        .upload-zone.drag-over {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
            transform: scale(1.02);
        }
        
        .upload-zone.has-file {
            border-color: var(--color-success);
            background: #f0fdf4;
        }
        
        .upload-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }
        
        .upload-text {
            color: var(--color-gray-600);
            margin-bottom: var(--spacing-sm);
        }
        
        .upload-hint {
            color: var(--color-gray-400);
            font-size: var(--font-size-sm);
        }
        
        .file-info {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: white;
            border-radius: var(--radius-md);
            display: none;
        }
        
        .file-info.visible {
            display: block;
        }
        
        .file-name {
            font-weight: 600;
            color: var(--color-gray-800);
            word-break: break-all;
        }
        
        .file-details {
            font-size: var(--font-size-sm);
            color: var(--color-gray-500);
            margin-top: var(--spacing-xs);
        }
        
        /* ========== Config Panel ========== */
        .config-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .config-group:last-child {
            margin-bottom: 0;
        }
        
        .config-label {
            display: block;
            font-weight: 500;
            color: var(--color-gray-700);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }
        
        .config-row {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .config-value {
            min-width: 50px;
            text-align: right;
            font-size: var(--font-size-sm);
            color: var(--color-gray-500);
            font-variant-numeric: tabular-nums;
        }
        
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            transition: border-color var(--transition-fast);
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }
        
        input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--color-gray-200);
            border-radius: 3px;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--color-primary);
            border-radius: 50%;
            cursor: pointer;
            transition: transform var(--transition-fast);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--color-primary);
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }
        
        input[type="color"] {
            width: 50px;
            height: 38px;
            padding: 2px;
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            cursor: pointer;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--color-primary);
            cursor: pointer;
        }
        
        .checkbox-label {
            font-size: var(--font-size-sm);
            color: var(--color-gray-700);
            user-select: none;
        }
        
        /* Template section */
        .template-section {
            padding: var(--spacing-md);
            background: var(--color-gray-50);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-sm);
            display: none;
        }
        
        .template-section.visible {
            display: block;
        }
        
        .template-preview {
            font-size: var(--font-size-xs);
            color: var(--color-gray-500);
            margin-top: var(--spacing-sm);
            font-style: italic;
        }
        
        /* ========== Preview ========== */
        .preview-container {
            position: relative;
            background: var(--color-gray-100);
            border-radius: var(--radius-lg);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .preview-placeholder {
            color: var(--color-gray-400);
            text-align: center;
            padding: var(--spacing-xl);
        }
        
        .preview-placeholder-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }
        
        #preview-canvas {
            max-width: 100%;
            max-height: 500px;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        
        #preview-canvas.visible {
            display: block;
        }
        
        .watermark-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        /* ========== Actions & Progress ========== */
        .actions {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .btn {
            padding: var(--spacing-md) var(--spacing-xl);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }
        
        .btn-primary {
            background: var(--color-primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:disabled {
            background: var(--color-gray-300);
            color: var(--color-gray-500);
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-container {
            display: none;
        }
        
        .progress-container.visible {
            display: block;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--color-gray-200);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: 4px;
            transition: width var(--transition-fast);
            width: 0%;
        }
        
        .progress-text {
            text-align: center;
            font-size: var(--font-size-sm);
            color: var(--color-gray-600);
            margin-top: var(--spacing-sm);
        }
        
        /* ========== Error Messages ========== */
        .error-message {
            background: var(--color-error-light);
            border: 1px solid var(--color-error);
            color: var(--color-error);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            display: none;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .error-message.visible {
            display: flex;
        }
        
        .error-icon {
            font-size: var(--font-size-lg);
        }
        
        /* ========== Validation States ========== */
        input.error {
            border-color: var(--color-error);
        }
        
        input.error:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        .char-count {
            font-size: var(--font-size-xs);
            color: var(--color-gray-400);
            text-align: right;
            margin-top: var(--spacing-xs);
        }
        
        .char-count.warning {
            color: var(--color-warning);
        }
        
        .char-count.error {
            color: var(--color-error);
        }
        
        /* ========== Browser Compatibility Warning ========== */
        .browser-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg);
            border-radius: var(--radius-lg);
            text-align: center;
            display: none;
        }
        
        .browser-warning.visible {
            display: block;
        }
        
        /* ========== Responsive ========== */
        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
                padding: var(--spacing-md);
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .upload-zone {
                padding: var(--spacing-xl);
            }
            
            .preview-container {
                min-height: 300px;
            }
        }
        
        @media (max-width: 480px) {
            :root {
                font-size: 14px;
            }
            
            .logo {
                font-size: var(--font-size-xl);
            }
            
            .upload-icon {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Browser Compatibility Warning -->
    <div id="browser-warning" class="browser-warning">
        <strong>‚ö†Ô∏è Navigateur non compatible</strong>
        <p>Votre navigateur ne supporte pas les fonctionnalit√©s requises. Veuillez utiliser Chrome, Firefox, Safari ou Edge r√©cent.</p>
    </div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="logo.png" alt="Stampify" class="logo-icon">
                <span>Stampify</span>
            </div>
            <span class="tagline">Ajoutez des filigranes √† vos PDF - 100% local, 100% priv√©</span>
        </div>
    </header>

    <main>
        <!-- Left Panel: Upload & Config -->
        <div class="left-panel">
            <!-- Error Display -->
            <div id="error-message" class="error-message">
                <span class="error-icon">‚ö†Ô∏è</span>
                <span id="error-text"></span>
            </div>

            <!-- Upload Zone -->
            <div class="card">
                <h2 class="card-title">üìÑ 1. S√©lectionnez un PDF</h2>
                <div id="upload-zone" class="upload-zone">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Glissez-d√©posez ou cliquez pour parcourir</div>
                    <div class="upload-hint">PDF uniquement (max 50 MB, 500 pages)</div>
                    <input type="file" id="file-input" accept=".pdf,application/pdf" hidden>
                </div>
                <div id="file-info" class="file-info">
                    <div id="file-name" class="file-name"></div>
                    <div id="file-details" class="file-details"></div>
                </div>
            </div>

            <!-- Config Panel -->
            <div class="card">
                <h2 class="card-title">‚úèÔ∏è 2. Configurez le filigrane</h2>
                
                <!-- Template checkbox -->
                <div class="config-group">
                    <label class="checkbox-group">
                        <input type="checkbox" id="use-template">
                        <span class="checkbox-label">Utiliser le mod√®le pr√©d√©fini</span>
                    </label>
                    
                    <!-- Template name input -->
                    <div id="template-section" class="template-section">
                        <label class="config-label" for="template-name">Nom du destinataire</label>
                        <input type="text" id="template-name" placeholder="Ex: Jean Dupont" maxlength="50">
                        <div id="template-preview" class="template-preview"></div>
                    </div>
                </div>
                
                <!-- Text input -->
                <div id="text-config" class="config-group">
                    <label class="config-label" for="watermark-text">Texte du filigrane</label>
                    <input type="text" id="watermark-text" placeholder="Ex: CONFIDENTIEL" maxlength="150">
                    <div id="char-count" class="char-count">0 / 150</div>
                </div>
                
                <!-- Font size slider -->
                <div class="config-group">
                    <label class="config-label">Taille de police</label>
                    <div class="config-row">
                        <input type="range" id="font-size" min="5" max="25" value="15">
                        <span id="font-size-value" class="config-value">15</span>
                    </div>
                </div>
                
                <!-- Opacity slider -->
                <div class="config-group">
                    <label class="config-label">Opacit√©</label>
                    <div class="config-row">
                        <input type="range" id="opacity" min="10" max="100" value="20">
                        <span id="opacity-value" class="config-value">20%</span>
                    </div>
                </div>
                
                <!-- Color picker -->
                <div class="config-group">
                    <label class="config-label">Couleur</label>
                    <div class="config-row">
                        <input type="color" id="color" value="#000000">
                        <span id="color-value" class="config-value">#000000</span>
                    </div>
                </div>
                
                <!-- Repeat checkbox -->
                <div class="config-group">
                    <label class="checkbox-group">
                        <input type="checkbox" id="repeat-mode" checked>
                        <span class="checkbox-label">R√©p√©ter le filigrane sur toute la page</span>
                    </label>
                </div>
            </div>

            <!-- Actions -->
            <div class="card actions">
                <button id="apply-btn" class="btn btn-primary" disabled>
                    <span>üñ®Ô∏è</span>
                    <span>Appliquer le filigrane</span>
                </button>
                
                <!-- Progress -->
                <div id="progress-container" class="progress-container">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div id="progress-text" class="progress-text">Traitement en cours...</div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Preview -->
        <div class="right-panel">
            <!-- Preview -->
            <div class="card" style="flex: 1;">
                <h2 class="card-title">üëÅÔ∏è 3. Aper√ßu</h2>
                <div class="preview-container">
                    <div id="preview-placeholder" class="preview-placeholder">
                        <div class="preview-placeholder-icon">üìÑ</div>
                        <div>L'aper√ßu appara√Ætra ici</div>
                    </div>
                    <canvas id="preview-canvas"></canvas>
                    <div id="watermark-overlay" class="watermark-overlay"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <p>
            <strong>Stampify</strong> - 100% local, vos documents ne quittent jamais votre ordinateur
            <br>
            <a href="https://github.com/YannMSFT/Stampify" target="_blank" rel="noopener">GitHub</a> ‚Ä¢ 
            Cr√©√© par <a href="https://github.com/YannMSFT" target="_blank" rel="noopener">Yann</a>
        </p>
    </footer>

    <!-- PDF-lib.js CDN -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <!-- Application JavaScript -->
    <script>
        // ========== Browser Feature Detection ==========
        (function checkBrowserCompatibility() {
            const required = [
                typeof FileReader !== 'undefined',
                typeof ArrayBuffer !== 'undefined',
                typeof Blob !== 'undefined',
                typeof URL !== 'undefined' && typeof URL.createObjectURL === 'function',
                typeof Promise !== 'undefined'
            ];
            
            if (!required.every(Boolean)) {
                document.getElementById('browser-warning').classList.add('visible');
                document.querySelector('main').style.display = 'none';
            }
        })();

        // ========== AppState Singleton ==========
        const AppState = {
            document: null,
            config: {
                text: '',
                useTemplate: false,
                templateName: '',
                fontSize: 15,
                opacity: 0.2,
                color: '#000000',
                rotation: 45,
                repeat: true
            },
            processing: {
                status: 'idle',
                currentPage: 0,
                totalPages: 0,
                progress: 0,
                errorMessage: null
            }
        };

        // ========== Utility Functions ==========
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16) / 255,
                g: parseInt(result[2], 16) / 255,
                b: parseInt(result[3], 16) / 255
            } : { r: 0, g: 0, b: 0 };
        }

        function degrees(deg) {
            return (deg * Math.PI) / 180;
        }

        // ========== Error Display ==========
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            errorEl.classList.add('visible');
            setTimeout(() => errorEl.classList.remove('visible'), 5000);
        }

        function hideError() {
            document.getElementById('error-message').classList.remove('visible');
        }

        // ========== File Validation ==========
        function validateFile(file) {
            const MAX_SIZE = 50 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                return { valid: false, error: 'Le fichier d√©passe la limite de 50 MB' };
            }
            if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
                return { valid: false, error: 'Format non support√©. Veuillez s√©lectionner un fichier PDF.' };
            }
            return { valid: true };
        }

        // ========== File Loading ==========
        async function loadFile(file) {
            const validation = validateFile(file);
            if (!validation.valid) throw new Error(validation.error);
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        let pdfDoc;
                        try {
                            pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer, { ignoreEncryption: false });
                        } catch (pdfError) {
                            if (pdfError.message.includes('encrypted') || pdfError.message.includes('password')) {
                                throw new Error('Ce PDF est prot√©g√© par mot de passe. Veuillez utiliser un PDF non prot√©g√©.');
                            }
                            throw new Error('Impossible de lire ce fichier PDF. Il est peut-√™tre corrompu.');
                        }
                        
                        const pageCount = pdfDoc.getPageCount();
                        if (pageCount > 500) {
                            throw new Error('Le document d√©passe la limite de 500 pages (' + pageCount + ' pages d√©tect√©es)');
                        }
                        
                        resolve({ file, name: file.name, size: file.size, pageCount, arrayBuffer, pdfDoc });
                    } catch (error) { reject(error); }
                };
                reader.onerror = () => reject(new Error('Erreur lors de la lecture du fichier'));
                reader.readAsArrayBuffer(file);
            });
        }

        // ========== Preview Rendering ==========
        function renderDefaultPreview() {
            const canvas = document.getElementById('preview-canvas');
            const ctx = canvas.getContext('2d');
            const placeholder = document.getElementById('preview-placeholder');
            
            // Dimensions A4 par d√©faut (595 x 842 points)
            const pdfWidth = 595;
            const pdfHeight = 842;
            
            const maxWidth = 500, maxHeight = 700;
            let scale = Math.min(maxWidth / pdfWidth, maxHeight / pdfHeight, 1);
            
            canvas.width = pdfWidth * scale;
            canvas.height = pdfHeight * scale;
            
            // Fond blanc pour simuler la page
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Bordure de la page
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            // Simuler du contenu avec des lignes grises
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            const lineHeight = 14;
            const margin = 40;
            const lineWidth = canvas.width - margin * 2;
            
            // Utiliser un seed fixe pour √©viter le changement al√©atoire
            const lines = [0.85, 0.72, 0.91, 0.68, 0.79, 0.88, 0.65, 0.94, 0.71, 0.82, 0.76, 0.89, 0.67, 0.93, 0.74, 0.86, 0.69, 0.91, 0.78, 0.84];
            let lineIndex = 0;
            
            for (let y = margin; y < canvas.height - margin; y += lineHeight * 2) {
                const widthFactor = lines[lineIndex % lines.length];
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(margin + lineWidth * widthFactor, y);
                ctx.stroke();
                lineIndex++;
            }
            
            // Texte d'info
            ctx.fillStyle = '#9ca3af';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Aper√ßu du filigrane (format A4)', canvas.width / 2, canvas.height - 15);
            
            placeholder.style.display = 'none';
            canvas.classList.add('visible');
            
            // Stocker les dimensions par d√©faut pour l'overlay
            if (!AppState.document) {
                AppState.defaultPageSize = { width: pdfWidth, height: pdfHeight };
            }
            
            updateWatermarkOverlay();
        }

        async function renderPreview(pdfDoc) {
            const canvas = document.getElementById('preview-canvas');
            const ctx = canvas.getContext('2d');
            const placeholder = document.getElementById('preview-placeholder');
            
            try {
                const pages = pdfDoc.getPages();
                if (pages.length === 0) return;
                
                const firstPage = pages[0];
                const { width, height } = firstPage.getSize();
                
                const maxWidth = 500, maxHeight = 700;
                let scale = Math.min(maxWidth / width, maxHeight / height, 1);
                
                canvas.width = width * scale;
                canvas.height = height * scale;
                
                // Fond blanc pour simuler la page
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Bordure de la page
                ctx.strokeStyle = '#d1d5db';
                ctx.lineWidth = 1;
                ctx.strokeRect(0, 0, canvas.width, canvas.height);
                
                // Simuler du contenu avec des lignes grises
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                const lineHeight = 14;
                const margin = 40;
                const lineWidth = canvas.width - margin * 2;
                
                for (let y = margin; y < canvas.height - margin; y += lineHeight * 2) {
                    const randomWidth = lineWidth * (0.6 + Math.random() * 0.4);
                    ctx.beginPath();
                    ctx.moveTo(margin, y);
                    ctx.lineTo(margin + randomWidth, y);
                    ctx.stroke();
                }
                
                // Texte d'info
                ctx.fillStyle = '#9ca3af';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Aper√ßu du filigrane', canvas.width / 2, canvas.height - 15);
                
                placeholder.style.display = 'none';
                canvas.classList.add('visible');
                updateWatermarkOverlay();
            } catch (error) {
                console.error('Preview error:', error);
            }
        }

        // ========== Unified Watermark Grid Calculator ==========
        // FR-023: Identique aper√ßu/rendu | FR-025: Espacement r√©gulier | FR-026: Pas de chevauchement
        
        /**
         * Calcule les positions exactes des filigranes pour une page donn√©e
         * @param {string} text - Texte du filigrane
         * @param {number} fontSize - Taille de police en points
         * @param {number} pageWidth - Largeur de la page
         * @param {number} pageHeight - Hauteur de la page
         * @param {number} rotation - Rotation en degr√©s
         * @returns {Array<{x: number, y: number}>} Liste des positions (origine: haut-gauche)
         */
        function calculateWatermarkPositions(text, fontSize, pageWidth, pageHeight, rotation) {
            // Calculer la taille du texte
            const charWidth = fontSize * 0.52; // Largeur moyenne Helvetica
            const textWidth = text.length * charWidth;
            const textHeight = fontSize;
            
            // Calculer l'emprise du texte apr√®s rotation (bounding box)
            const radians = (rotation * Math.PI) / 180;
            const cos = Math.abs(Math.cos(radians));
            const sin = Math.abs(Math.sin(radians));
            const rotatedWidth = textWidth * cos + textHeight * sin;
            const rotatedHeight = textWidth * sin + textHeight * cos;
            
            // Espacement = taille du texte rotat√© + marge fixe (FR-025, FR-026)
            const marginX = fontSize * 2;
            const marginY = fontSize * 2;
            const spacingX = rotatedWidth + marginX;
            const spacingY = rotatedHeight + marginY;
            
            // Calculer le nombre de colonnes et lignes n√©cessaires
            const cols = Math.ceil(pageWidth / spacingX) + 1;
            const rows = Math.ceil(pageHeight / spacingY) + 1;
            
            // Centrer la grille sur la page
            const totalWidth = (cols - 1) * spacingX;
            const totalHeight = (rows - 1) * spacingY;
            const offsetX = (pageWidth - totalWidth) / 2;
            const offsetY = (pageHeight - totalHeight) / 2;
            
            // G√©n√©rer les positions
            const positions = [];
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    positions.push({
                        x: offsetX + col * spacingX,
                        y: offsetY + row * spacingY
                    });
                }
            }
            
            return { positions, spacingX, spacingY, rotatedWidth, rotatedHeight };
        }

        function updateWatermarkOverlay() {
            const overlay = document.getElementById('watermark-overlay');
            const canvas = document.getElementById('preview-canvas');
            
            if (!canvas.classList.contains('visible')) { overlay.innerHTML = ''; return; }
            
            const text = getEffectiveText();
            if (!text) { overlay.innerHTML = ''; return; }
            
            const config = AppState.config;
            const pdfPage = AppState.document?.pdfDoc?.getPages()[0];
            const pdfWidth = pdfPage?.getSize().width || 595; // A4 default
            const pdfHeight = pdfPage?.getSize().height || 842;
            const scale = canvas.width / pdfWidth;
            
            overlay.innerHTML = '';
            overlay.style.cssText = `
                width: ${canvas.width}px;
                height: ${canvas.height}px;
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                overflow: hidden;
            `;
            
            if (config.repeat) {
                // Calculer sur les dimensions PDF, puis mettre √† l'√©chelle
                const { positions } = calculateWatermarkPositions(
                    text, config.fontSize, pdfWidth, pdfHeight, config.rotation
                );
                
                positions.forEach(pos => {
                    const span = document.createElement('span');
                    span.textContent = text;
                    span.style.cssText = `
                        position: absolute;
                        left: ${pos.x * scale}px;
                        top: ${pos.y * scale}px;
                        transform: translate(-50%, -50%) rotate(-${config.rotation}deg);
                        font-size: ${config.fontSize * scale}px;
                        color: ${config.color};
                        opacity: ${config.opacity};
                        white-space: nowrap;
                        font-family: Helvetica, Arial, sans-serif;
                        pointer-events: none;
                    `;
                    overlay.appendChild(span);
                });
            } else {
                const span = document.createElement('span');
                span.textContent = text;
                span.style.cssText = `
                    position: absolute;
                    left: 50%;
                    top: 50%;
                    transform: translate(-50%, -50%) rotate(-${config.rotation}deg);
                    font-size: ${config.fontSize * scale}px;
                    color: ${config.color};
                    opacity: ${config.opacity};
                    white-space: nowrap;
                    font-family: Helvetica, Arial, sans-serif;
                    pointer-events: none;
                `;
                overlay.appendChild(span);
            }
        }

        // ========== Watermark Config ==========
        function getConfig() { return { ...AppState.config }; }
        
        function updateConfig(partial) {
            Object.assign(AppState.config, partial);
            updateWatermarkOverlay();
            updateApplyButton();
        }

        function getEffectiveText() {
            if (AppState.config.useTemplate && AppState.config.templateName) {
                return 'Document exclusivement destin√© √† l\'usage de ' + AppState.config.templateName;
            }
            return AppState.config.text;
        }

        // ========== PDF Processing ==========
        async function applyWatermark(pdfDoc, config, onProgress) {
            const pdfBytes = await pdfDoc.save();
            const workingDoc = await PDFLib.PDFDocument.load(pdfBytes);
            
            const pages = workingDoc.getPages();
            const totalPages = pages.length;
            const font = await workingDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            
            const text = getEffectiveText();
            const { r, g, b } = hexToRgb(config.color);
            const rgb = PDFLib.rgb(r, g, b);
            
            for (let i = 0; i < totalPages; i++) {
                const page = pages[i];
                const { width, height } = page.getSize();
                
                if (config.repeat) {
                    // FR-023: Utiliser EXACTEMENT le m√™me calcul que l'aper√ßu
                    const { positions } = calculateWatermarkPositions(
                        text, config.fontSize, width, height, config.rotation
                    );
                    
                    positions.forEach(pos => {
                        // Conversion coordonn√©es: aper√ßu (Y‚Üì) vers PDF (Y‚Üë)
                        // Dans l'aper√ßu: pos.y = distance depuis le HAUT
                        // Dans le PDF: y = distance depuis le BAS
                        const pdfY = height - pos.y;
                        
                        page.drawText(text, { 
                            x: pos.x, 
                            y: pdfY, 
                            size: config.fontSize, 
                            font, 
                            color: rgb, 
                            opacity: config.opacity, 
                            rotate: PDFLib.degrees(config.rotation) 
                        });
                    });
                } else {
                    // Filigrane unique centr√©
                    const textWidth = font.widthOfTextAtSize(text, config.fontSize);
                    page.drawText(text, { 
                        x: width / 2, 
                        y: height / 2, 
                        size: config.fontSize, 
                        font, 
                        color: rgb, 
                        opacity: config.opacity, 
                        rotate: PDFLib.degrees(config.rotation) 
                    });
                }
                
                if (onProgress) onProgress(i + 1, totalPages);
            }
            
            return await workingDoc.save();
        }

        function triggerDownload(bytes, filename) {
            const blob = new Blob([bytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        function generateOutputFilename(originalName) {
            return originalName.replace(/\.pdf$/i, '') + '_watermarked.pdf';
        }

        function updateApplyButton() {
            const btn = document.getElementById('apply-btn');
            btn.disabled = !AppState.document || !getEffectiveText().trim() || AppState.processing.status === 'processing';
        }

        // ========== Event Handlers ==========
        async function handleFileSelect(file) {
            hideError();
            try {
                const docInfo = await loadFile(file);
                AppState.document = docInfo;
                
                document.getElementById('upload-zone').classList.add('has-file');
                document.getElementById('file-info').classList.add('visible');
                document.getElementById('file-name').textContent = docInfo.name;
                document.getElementById('file-details').textContent = (docInfo.size / (1024 * 1024)).toFixed(2) + ' MB ‚Ä¢ ' + docInfo.pageCount + ' page' + (docInfo.pageCount > 1 ? 's' : '');
                
                await renderPreview(docInfo.pdfDoc);
                updateApplyButton();
            } catch (error) {
                showError(error.message);
                AppState.document = null;
                updateApplyButton();
            }
        }

        function updateCharCount() {
            const text = document.getElementById('watermark-text').value;
            const charCount = document.getElementById('char-count');
            charCount.textContent = text.length + ' / 150';
            charCount.classList.remove('warning', 'error');
            if (text.length > 150) charCount.classList.add('error');
            else if (text.length > 120) charCount.classList.add('warning');
        }

        function updateTemplatePreview() {
            const preview = document.getElementById('template-preview');
            if (AppState.config.useTemplate && AppState.config.templateName) {
                preview.textContent = 'Aper√ßu: "' + getEffectiveText() + '"';
            } else if (AppState.config.useTemplate) {
                preview.textContent = 'Entrez un nom pour voir l\'aper√ßu';
            } else {
                preview.textContent = '';
            }
        }

        async function handleApply() {
            if (!AppState.document || !getEffectiveText().trim()) return;
            
            const applyBtn = document.getElementById('apply-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            try {
                AppState.processing.status = 'processing';
                applyBtn.disabled = true;
                progressContainer.classList.add('visible');
                
                const pdfBytes = await applyWatermark(AppState.document.pdfDoc, AppState.config, (current, total) => {
                    const percent = Math.round((current / total) * 100);
                    progressFill.style.width = percent + '%';
                    progressText.textContent = 'Page ' + current + ' sur ' + total;
                });
                
                triggerDownload(pdfBytes, generateOutputFilename(AppState.document.name));
                progressText.textContent = '‚úÖ Termin√© ! T√©l√©chargement en cours...';
                AppState.processing.status = 'complete';
                
                setTimeout(() => {
                    progressContainer.classList.remove('visible');
                    progressFill.style.width = '0%';
                    AppState.processing.status = 'idle';
                    updateApplyButton();
                }, 2000);
            } catch (error) {
                showError('Erreur lors du traitement: ' + error.message);
                AppState.processing.status = 'error';
                progressContainer.classList.remove('visible');
                updateApplyButton();
            }
        }

        // ========== Initialization ==========
        function initEventListeners() {
            const uploadZone = document.getElementById('upload-zone');
            const fileInput = document.getElementById('file-input');
            
            uploadZone.addEventListener('click', () => fileInput.click());
            uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
            uploadZone.addEventListener('dragleave', (e) => { e.preventDefault(); uploadZone.classList.remove('drag-over'); });
            uploadZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) await handleFileSelect(e.dataTransfer.files[0]);
            });
            
            fileInput.addEventListener('change', async (e) => {
                if (e.target.files.length > 0) await handleFileSelect(e.target.files[0]);
            });
            
            document.getElementById('watermark-text').addEventListener('input', (e) => { updateConfig({ text: e.target.value }); updateCharCount(); });
            document.getElementById('font-size').addEventListener('input', (e) => { const v = parseInt(e.target.value); document.getElementById('font-size-value').textContent = v; updateConfig({ fontSize: v }); });
            document.getElementById('opacity').addEventListener('input', (e) => { const v = parseInt(e.target.value); document.getElementById('opacity-value').textContent = v + '%'; updateConfig({ opacity: v / 100 }); });
            document.getElementById('color').addEventListener('input', (e) => { document.getElementById('color-value').textContent = e.target.value; updateConfig({ color: e.target.value }); });
            document.getElementById('repeat-mode').addEventListener('change', (e) => { updateConfig({ repeat: e.target.checked }); });
            
            document.getElementById('use-template').addEventListener('change', (e) => {
                document.getElementById('template-section').classList.toggle('visible', e.target.checked);
                document.getElementById('text-config').style.display = e.target.checked ? 'none' : 'block';
                updateConfig({ useTemplate: e.target.checked });
                updateTemplatePreview();
            });
            
            document.getElementById('template-name').addEventListener('input', (e) => { updateConfig({ templateName: e.target.value }); updateTemplatePreview(); });
            document.getElementById('apply-btn').addEventListener('click', handleApply);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            updateApplyButton();
            document.getElementById('font-size').value = AppState.config.fontSize;
            document.getElementById('font-size-value').textContent = AppState.config.fontSize;
            document.getElementById('opacity').value = AppState.config.opacity * 100;
            document.getElementById('opacity-value').textContent = Math.round(AppState.config.opacity * 100) + '%';
            document.getElementById('color').value = AppState.config.color;
            document.getElementById('color-value').textContent = AppState.config.color;
            document.getElementById('repeat-mode').checked = AppState.config.repeat;
            
            // Afficher l'aper√ßu par d√©faut imm√©diatement
            renderDefaultPreview();
        });
    </script>
</body>
</html>
